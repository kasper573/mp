{
	order rate_limit before basicauth
    email admin@{$MP_DOMAIN}
}

(common_rate_limit) {
    rate_limit {
        zone dynamic_zone {
            key {http.request.remote_ip}
            events {$CADDY_RATE_LIMIT_EVENTS}
            window 5s
        }
    }
}

(common_cors) {
    @options {
        method OPTIONS
    }
    header {
        Access-Control-Allow-Origin "https://{$MP_WEBSITE_DOMAIN}"
        Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
        Access-Control-Allow-Credentials true
    }
    respond @options 204
}

grafana.{$MP_DOMAIN} {
    reverse_proxy http://grafana:3000
}

auth.{$MP_DOMAIN} {
    tracing {
        span keycloak
    }
    reverse_proxy keycloak:8080
}

faro.{$MP_DOMAIN} {
    reverse_proxy alloy:18273
}

{$MP_FILE_SERVER_DOMAIN} {
    import common_rate_limit
    tracing {
        span file_server
    }
    reverse_proxy file-server:80
    import common_cors
}

{$MP_WEBSITE_DOMAIN} {
    import common_rate_limit
    
    # In dev mode, MP_WEBSITE_PROXY_HOST is set to host.docker.internal:5173
    # In prod/test mode, MP_WEBSITE_PROXY_HOST is unset and we serve static files
    @proxy_mode {
        expression {env.MP_WEBSITE_PROXY_HOST} != ""
    }
    
    # Proxy mode (development)
    handle @proxy_mode {
        reverse_proxy {$MP_WEBSITE_PROXY_HOST}
    }
    
    # Static file serving mode (production/test)
    handle {
        # Serve static website files from the shared volume
        root * /srv/mp-website
        
        # Try serving the file, fallback to index.html for SPA
        try_files {path} /index.html
        
        # Enable file server
        file_server
        
        # Set cache headers for static assets
        @static {
            path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.woff *.woff2 *.wasm *.eot *.ttf *.otf *.svg *.webp
        }
        header @static Cache-Control "public, max-age=15552000"
    }
}

{$MP_API_DOMAIN} {
    import common_rate_limit
    tracing {
        span mp_api
    }
    reverse_proxy {$MP_API_PROXY_HOST}
    import common_cors
}

{$MP_GATEWAY_DOMAIN} {
    import common_rate_limit
    tracing {
        span mp_gateway
    }
    reverse_proxy {$MP_GATEWAY_PROXY_HOST}
    import common_cors
}
